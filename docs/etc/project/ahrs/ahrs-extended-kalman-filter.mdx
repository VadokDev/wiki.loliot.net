---
id: ahrs-extended-kalman-filter
title: AHRS Extended Kalman filter
sidebar_label: Extended Kalman filter
description: AHRS(Attitude and heading reference system) Extended Kalman filter
keywords:
  - AHRS
  - Kalman
  - Extended
---

import useBaseUrl from "@docusaurus/useBaseUrl";

<link rel="stylesheet" href={useBaseUrl("katex/katex.min.css")} />

The extended Kalman filter(EKF) is the nonlinear version of the Kalman filter. EKF has 'Predict' and 'Update' stages and recursivley estimates target values.

# Predict

$$
x_k = q^0_k = \begin{bmatrix} q_x & q_y & q_z & q_w \end{bmatrix}^T
$$

$$
q^{k-1}_k \approx \begin{bmatrix}
\dfrac {\omega_x \Delta t} {2} &
\dfrac {\omega_y \Delta t} {2} &
\dfrac {\omega_z \Delta t} {2} &
1
\end{bmatrix}^T
$$

$$
\hat{x}_{k|k-1} = f (\hat{x}_{k-1|k-1},u_k) = \hat{x}_{k-1|k-1}q^{k-1}_k
$$

$$
\hat{x}_{k|k-1} = R(q^{k-1}_k) \hat{x}_{k-1|k-1}
= \begin{bmatrix}
1 & \dfrac {\omega_z \Delta t} {2} & - \dfrac {\omega_y \Delta t} {2} & \dfrac {\omega_x \Delta t} {2} \\
- \dfrac {\omega_z \Delta t} {2} & 1 & \dfrac {\omega_x \Delta t} {2} & \dfrac {\omega_y \Delta t} {2} \\
\dfrac {\omega_y \Delta t} {2} & - \dfrac {\omega_x \Delta t} {2} & 1 & \dfrac {\omega_z \Delta t} {2} \\
- \dfrac {\omega_x \Delta t} {2} & - \dfrac {\omega_y \Delta t} {2} & - \dfrac {\omega_z \Delta t} {2} & 1
\end{bmatrix}
\hat{x}_{k-1|k-1}
$$

$$
F_k =\left. \dfrac{\partial f}{\partial x} \right|_{\hat{x}_{k-1|k-1},u_k}
=
\begin{bmatrix}
1 & \dfrac {\omega_z \Delta t} {2} & - \dfrac {\omega_y \Delta t} {2} & \dfrac {\omega_x \Delta t} {2} \\
- \dfrac {\omega_z \Delta t} {2} & 1 & \dfrac {\omega_x \Delta t} {2} & \dfrac {\omega_y \Delta t} {2} \\
\dfrac {\omega_y \Delta t} {2} & - \dfrac {\omega_x \Delta t} {2} & 1 & \dfrac {\omega_z \Delta t} {2} \\
- \dfrac {\omega_x \Delta t} {2} & - \dfrac {\omega_y \Delta t} {2} & - \dfrac {\omega_z \Delta t} {2} & 1
\end{bmatrix}
$$

$$
P_{k|k-1} = F_k P_{k-1|k-1} F^T_k + Q_k
$$

# Update

$$
{}^0a = \begin{bmatrix} 0 & 0 & g & 0 \end{bmatrix}^T
$$

$$
\begin{aligned}
\dfrac{{}^k\hat{a}} {\lVert {}^k\hat{a} \rVert}
&= h_a(\hat{x}_{k|k-1}) \\
&= \overline{\hat{x}_{k|k-1}} \left( \dfrac{{}^0a} {\lVert {}^0a \rVert} \right) \hat{x}_{k|k-1}
= \begin{bmatrix}
  2(q_x q_z - q_y q_w) \\
  2(q_x q_w + q_y q_z) \\
  -q^2_x - q^2_y + q^2_z + q^2_w
  \end{bmatrix}
\end{aligned}
$$

$$
{}^0m = \begin{bmatrix} {}^0m_x & 0 & {}^0m_z & 0 \end{bmatrix}^T
$$

$$
{}^0a \times {}^0m = \begin{bmatrix} 0 & {}^0m_x g & 0 & 0 \end{bmatrix}^T
$$

$$
\begin{aligned}
\dfrac{{}^k\hat{a} \times {}^k\hat{m}} {\lVert {}^k\hat{a} \times {}^k\hat{m} \rVert}
&= h_{a \times m}( \hat{x}_{k|k-1} ) \\
&= \overline{\hat{x}_{k|k-1}} \left( \dfrac{{}^0a \times {}^0m} {\lVert {}^0a \times {}^0m \rVert} \right) \hat{x}_{k|k-1}
= \begin{bmatrix}
  2(q_x q_y + q_z q_w) \\
  -q^2_x + q^2_y - q^2_z + q^2_w \\
  2(q_y q_z - q_x q_w)
  \end{bmatrix}
\end{aligned}
$$

$$
z_k
= \begin{bmatrix}
  \dfrac{{}^ka} {\lVert {}^ka \rVert} \\
  \dfrac{{}^ka \times {}^km} {\lVert {}^ka \times {}^km \rVert}
  \end{bmatrix}
\quad
h( \hat{x}_{k|k-1} )
= \begin{bmatrix}
  h_a(\hat{x}_{k|k-1}) \\
  h_{a \times m}( \hat{x}_{k|k-1} )
  \end{bmatrix}
$$

$$
\tilde{y}_k = z_k -  h( \hat{x}_{k|k-1} )
$$

$$
H_k
= 2 \begin{bmatrix}
  q_z & -q_w & q_x & -q_y \\
  q_w & q_z & q_y & q_x \\
  -q_x & -q_y & q_z & q_w \\
  q_y & q_x & q_w & q_z \\
  -q_x & q_y & -q_z & q_w \\
  -q_w & q_z & q_y & -q_x
  \end{bmatrix}
$$

$$
S_k = H_k P_{k|k-1} H^T_k + R_k
$$

$$
K_k = P_{k|k-1} H^T_k S^{-1}_k
$$

$$
P_{k|k} = (I - K_k H_k) P_{k|k-1}
$$

$$
\hat{x}_{k|k} = \hat{x}_{k|k-1} + K_k \tilde{y}_k
$$

# Reference

- Matthew Watson, Luke Seed, and Chee Hing Tan, 2013, “The Design and Implementation of a robust AHRS for Integration into a Quadrotor Platform.”, p.14 ~ p.34
- Heikki Hyyiti, and Arto Visala, 2015, “A DCM Based Attitude Estimation Algorithm for Low-Cost MEMS IMUs”, p.4 ~ p.5
